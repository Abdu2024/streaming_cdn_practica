<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Streaming CDN - Práctica</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.20.3/video-js.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .video-container {
            margin-bottom: 30px;
        }
        .stats-container {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .stat-box {
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-container {
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .tab-button {
            padding: 10px 15px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
        }
        .tab-content.active {
            display: block;
        }
        #log-container {
            height: 200px;
            overflow-y: auto;
            background-color: #f0f0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .timestamp {
            color: #0066cc;
        }
        .event-type {
            font-weight: bold;
            margin-right: 5px;
        }
        .event-info {
            color: #333;
        }
        .export-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Práctica de Streaming con CDN</h1>
    
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('live-tab')">Streaming en Directo</button>
            <button class="tab-button" onclick="openTab('vod-tab')">Video Bajo Demanda</button>
            <button class="tab-button" onclick="openTab('stats-tab')">Estadísticas & Logs</button>
        </div>
        
        <div id="live-tab" class="tab-content active">
            <h2>Streaming en Directo con CDN</h2>
            <div class="video-container">
                <video
                    id="live-player"
                    class="video-js vjs-default-skin vjs-big-play-centered"
                    controls
                    width="960"
                    height="540"
                    data-setup='{}'>
                    <!-- La URL se configurará vía JavaScript -->
                </video>
            </div>
            
            <div class="stream-info">
                <h3>Información de la Transmisión</h3>
                <p>Estado: <span id="stream-status">Conectando...</span></p>
                <p>Resolución actual: <span id="stream-resolution">-</span></p>
                <p>Bitrate: <span id="stream-bitrate">-</span> kbps</p>
                <p>Latencia: <span id="stream-latency">-</span> ms</p>
                <p>Tiempo de visualización: <span id="viewing-time">00:00:00</span></p>
            </div>
        </div>
        
        <div id="vod-tab" class="tab-content">
            <h2>Video Bajo Demanda (VOD) con CDN</h2>
            <div class="video-container">
                <video
                    id="vod-player"
                    class="video-js vjs-default-skin vjs-big-play-centered"
                    controls
                    width="960"
                    height="540"
                    data-setup='{}'>
                    <!-- La URL se configurará vía JavaScript -->
                </video>
            </div>
        </div>
        
        <div id="stats-tab" class="tab-content">
            <h2>Estadísticas de Distribución CDN</h2>
            
            <div class="stats-container">
                <h3>Métricas de Rendimiento</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <h4>Latencia Media</h4>
                        <p id="avg-latency">0 ms</p>
                    </div>
                    <div class="stat-box">
                        <h4>Cambios de Calidad</h4>
                        <p id="quality-switches">0</p>
                    </div>
                    <div class="stat-box">
                        <h4>Tiempo de Buffering</h4>
                        <p id="buffer-time">0 ms</p>
                    </div>
                    <div class="stat-box">
                        <h4>Ancho de Banda Promedio</h4>
                        <p id="avg-bandwidth">0 Mbps</p>
                    </div>
                    <div class="stat-box">
                        <h4>Pico de Espectadores</h4>
                        <p id="peak-viewers">1</p>
                    </div>
                    <div class="stat-box">
                        <h4>Rendimiento CDN</h4>
                        <p id="cdn-performance">100%</p>
                    </div>
                </div>
            </div>
            
            <h3>Registro de Eventos</h3>
            <div id="log-container">
                <!-- Los eventos se añadirán aquí dinámicamente -->
            </div>
            <button id="export-log" class="export-btn">Exportar Registros</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.20.3/video.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-hls/5.15.0/videojs-contrib-hls.min.js"></script>
    
    <script>
        // Configuración de URLs (reemplazar con tus propias URLs)
        const liveStreamUrl = "https://example-stream-cdn.com/live/stream.m3u8"; // URL de tu stream en vivo
        const vodUrl = "https://example-cdn.com/videos/sample-video.mp4"; // URL de tu video bajo demanda
        
        // Variables para el seguimiento
        let viewingStartTime = null;
        let qualitySwitches = 0;
        let bufferingEvents = 0;
        let bufferingTime = 0;
        let latencyMeasurements = [];
        let bandwidthMeasurements = [];
        let currentResolution = "-";
        let currentBitrate = 0;
        let logEntries = [];
        
        // Inicialización de los reproductores
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar reproductor en vivo
            const livePlayer = videojs('live-player');
            livePlayer.src({
                src: liveStreamUrl,
                type: 'application/x-mpegURL' // HLS stream
            });
            
            // Inicializar reproductor VOD
            const vodPlayer = videojs('vod-player');
            vodPlayer.src({
                src: vodUrl,
                type: 'video/mp4'
            });
            
            // Eventos para el reproductor en vivo
            livePlayer.on('loadstart', function() {
                logEvent('SISTEMA', 'Iniciando carga del stream');
            });
            
            livePlayer.on('loadedmetadata', function() {
                logEvent('STREAM', 'Metadata cargada, stream disponible');
                document.getElementById('stream-status').textContent = 'Conectado';
                viewingStartTime = new Date();
                updateViewingTime();
            });
            
            livePlayer.on('playing', function() {
                logEvent('REPRODUCCIÓN', 'Stream en reproducción');
                document.getElementById('stream-status').textContent = 'Reproduciendo';
                simulateStreamStats(); // Iniciar simulación de estadísticas
            });
            
            livePlayer.on('waiting', function() {
                logEvent('BUFFER', 'Buffering...');
                bufferingEvents++;
                const bufferStartTime = new Date();
                
                const bufferInterval = setInterval(() => {
                    if (!livePlayer.paused() && !livePlayer.seeking()) {
                        const bufferDuration = new Date() - bufferStartTime;
                        bufferingTime += bufferDuration;
                        document.getElementById('buffer-time').textContent = bufferingTime + ' ms';
                        logEvent('BUFFER', `Buffering completado después de ${bufferDuration} ms`);
                        clearInterval(bufferInterval);
                    }
                }, 100);
            });
            
            livePlayer.on('error', function() {
                logEvent('ERROR', 'Error en la reproducción: ' + livePlayer.error().message);
                document.getElementById('stream-status').textContent = 'Error';
            });
        });
        
        // Función para actualizar el tiempo de visualización
        function updateViewingTime() {
            if (viewingStartTime) {
                const now = new Date();
                const diff = now - viewingStartTime;
                const hours = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const minutes = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const seconds = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                
                document.getElementById('viewing-time').textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            setTimeout(updateViewingTime, 1000);
        }
        
        // Simulación de estadísticas de streaming (para la práctica)
        function simulateStreamStats() {
            // Simulación de cambios de resolución
            const resolutions = ['640x360', '854x480', '1280x720', '1920x1080'];
            const bitrates = [800, 1500, 3000, 6000];
            
            // Actualizar cada 5 segundos
            setInterval(() => {
                // Simular cambios de resolución y bitrate
                const randomIndex = Math.floor(Math.random() * resolutions.length);
                const newResolution = resolutions[randomIndex];
                const newBitrate = bitrates[randomIndex];
                
                if (newResolution !== currentResolution) {
                    currentResolution = newResolution;
                    currentBitrate = newBitrate;
                    document.getElementById('stream-resolution').textContent = currentResolution;
                    document.getElementById('stream-bitrate').textContent = currentBitrate;
                    qualitySwitches++;
                    document.getElementById('quality-switches').textContent = qualitySwitches;
                    logEvent('CALIDAD', `Cambio de calidad a ${currentResolution} (${currentBitrate} kbps)`);
                }
                
                // Simular medición de latencia
                const latency = 200 + Math.random() * 300;
                document.getElementById('stream-latency').textContent = Math.round(latency);
                latencyMeasurements.push(latency);
                
                // Actualizar latencia media
                const avgLatency = latencyMeasurements.reduce((sum, val) => sum + val, 0) / latencyMeasurements.length;
                document.getElementById('avg-latency').textContent = `${Math.round(avgLatency)} ms`;
                
                // Simular medición de ancho de banda
                const bandwidth = 1 + Math.random() * 9; // Entre 1 y 10 Mbps
                bandwidthMeasurements.push(bandwidth);
                
                // Actualizar ancho de banda promedio
                const avgBandwidth = bandwidthMeasurements.reduce((sum, val) => sum + val, 0) / bandwidthMeasurements.length;
                document.getElementById('avg-bandwidth').textContent = `${avgBandwidth.toFixed(2)} Mbps`;
                
                // Actualizar rendimiento simulado del CDN
                const cdnPerformance = 95 + Math.random() * 5; // Entre 95% y 100%
                document.getElementById('cdn-performance').textContent = `${cdnPerformance.toFixed(1)}%`;
                
            }, 5000);
        }
        
        // Función para cambiar entre pestañas
        function openTab(tabId) {
            // Ocultar todos los contenidos de pestañas
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Desactivar todos los botones de pestañas
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Activar la pestaña seleccionada
            document.getElementById(tabId).classList.add('active');
            
            // Activar el botón correspondiente
            const activeButton = document.querySelector(`.tab-button[onclick="openTab('${tabId}')"]`);
            activeButton.classList.add('active');
            
            // Pausar los reproductores al cambiar de pestaña
            if (tabId !== 'live-tab') {
                videojs('live-player').pause();
            }
            
            if (tabId !== 'vod-tab') {
                videojs('vod-player').pause();
            }
        }
        
        // Función para registrar eventos
        function logEvent(type, message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString() + '.' + now.getMilliseconds().toString().padStart(3, '0');
            
            const logEntry = {
                timestamp: timestamp,
                type: type,
                message: message
            };
            
            logEntries.push(logEntry);
            
            const logContainer = document.getElementById('log-container');
            const logElement = document.createElement('div');
            logElement.className = 'log-entry';
            logElement.innerHTML = `
                <span class="timestamp">[${logEntry.timestamp}]</span>
                <span class="event-type">[${logEntry.type}]</span>
                <span class="event-info">${logEntry.message}</span>
            `;
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Función para exportar logs
        document.getElementById('export-log').addEventListener('click', function() {
            // Crear contenido del archivo de log
            let logContent = "REGISTRO DE STREAMING CON CDN - Exportado: " + new Date().toLocaleString() + "\n\n";
            
            logEntries.forEach(entry => {
                logContent += `[${entry.timestamp}] [${entry.type}] ${entry.message}\n`;
            });
            
            // Añadir estadísticas
            logContent += "\n\n--- ESTADÍSTICAS DEL STREAMING ---\n";
            logContent += "Tiempo de visualización: " + document.getElementById('viewing-time').textContent + "\n";
            logContent += "Resolución final: " + document.getElementById('stream-resolution').textContent + "\n";
            logContent += "Bitrate final: " + document.getElementById('stream-bitrate').textContent + " kbps\n";
            logContent += "Cambios de calidad: " + document.getElementById('quality-switches').textContent + "\n";
            logContent += "Latencia media: " + document.getElementById('avg-latency').textContent + "\n";
            logContent += "Ancho de banda promedio: " + document.getElementById('avg-bandwidth').textContent + "\n";
            logContent += "Rendimiento del CDN: " + document.getElementById('cdn-performance').textContent + "\n";
            
            // Crear y descargar el archivo
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'streaming-cdn-log_' + new Date().toISOString().replace(/[:\.]/g, '-') + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logEvent('SISTEMA', 'Registro exportado correctamente');
        });
        
        // Iniciar con algunos eventos de log
        setTimeout(() => {
            logEvent('SISTEMA', 'Interfaz de monitorización iniciada');
            logEvent('CDN', 'Conexión con CDN establecida');
            logEvent('CONFIGURACIÓN', 'Streaming HLS configurado con adaptación de bitrate');
        }, 500);
    </script>
</body>
</html>
